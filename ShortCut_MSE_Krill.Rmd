---
title: "![](logoUMAG.jpg){width=4cm}"
output:
  pdf_document:
    includes:
      before_body: titulo.sty
    keep_tex: yes
    number_sections: no
    toc: true
    toc_depth: 3
bibliography: SA_krill.bib
csl: apa.csl
link-citations: yes
linkcolor: blue
indent: no
header-includes:
- \usepackage{fancyhdr}
- \pagestyle{fancy}
- \fancyhf{}
- \lfoot[\thepage]{}
- \rfoot[]{\thepage}
---


```{=tex}
\fontsize{10}{18}
\selectfont
```

```{r  setup, eval=FALSE, include=FALSE, message=F}
rm(list = ls())
options(bitmapType = "cairo") 
#XQuartz is a mess, put this in your onload to default to cairo instead (https://github.com/tidyverse/ggplot2/issues/2655)
# Lo mapas se hacen mas rapido
# solo para IOs
```


```{r setup2, echo = FALSE, warning = FALSE, message = FALSE}
library(knitr)
opts_chunk$set(
  collapse = TRUE,
  comment = "  ",
  fig.align = 'center',
  cache = FALSE,
  tidy.opts = list(width.cutoff = 55),
  tidy = TRUE
)

knit_hooks$set(output = function(x, options) {
  if (!is.null(n <- options$linewidth)) {
    x <- knitr:::split_lines(x)
    if (any(nchar(x) > n)) x <- strwrap(x, width = n)
    x <- paste(x, collapse = '\n')
  }
  x
})
```

\pagebreak

# INTRODUCTION

This work presents a Management Strategy Evaluation (MSE) framework applied to Antarctic krill (*Euphausia superba*) in the Western Antarctic Peninsula (WAP), representing the first implementation of an MSE based on an integrated stock assessment model using `SS3` (Stock Synthesis 3) as the operating model for this species.

The simulation framework is structured following the general principles developed under the ICES MSE BlackSteam Working Group, and it draws heavily on methodologies established in the **FLR** (Fisheries Library in R) framework. The MSE is built upon FLR packages such as `FLCore`, `FLAssess`, and `FLasher`, which provide the computational tools and object-oriented architecture to implement and evaluate management strategies in a reproducible and flexible way.

The objective of this MSE is to test the performance of alternative Harvest Control Rules (HCRs) in meeting predefined conservation and yield objectives under uncertainty in stock dynamics and observation processes. The operating model (OM) represents the "true" krill population dynamics, incorporating recruitment variability, environmental forcing, and stochasticity in both biological and fishery processes. The estimation model (EM) simulates the application of a stock assessment under realistic monitoring and assessment error, informing annual catch limits.

By adopting this approach, the study provides a transparent and policy-relevant evaluation of candidate HCRs for krill fisheries in the WAP, in this case, the currently catch limit. This research is developed within an academic framework and aims to provide a methodological contribution to the ongoing discussions regarding the revision of krill new management strategy under CCAMLR. By demonstrating the feasibility and utility of implementing a Management Strategy Evaluation using an SS3-based operating model and tools from the FLR framework, this study offers a scientifically robust foundation to support the development of adaptive, ecosystem-informed harvest strategies aligned with the precautionary and ecosystem-based principles of CCAMLR.

All model code process and simulation tools will made openly available to the scientific community, encouraging transparency, reproducibility, and constructive feedback to refine and strengthen this approach through collaborative development.


```{r, echo=FALSE, message=FALSE,warning=FALSE}
# Load
library(ggplot2)
library(FLCore)
library(ggplotFL)
library(mse)
library(FLRef)
library(ggpubr)
library(mseviz)
library(r4ss)
library(doParallel)
library(here)
library(ss3sim)
library(kableExtra)
```

## Short-Cut MSE for Harvest Control Rule (HCR) in krill 


Different to Management Strategy Evaluation (MSE) simulation design (Punt et al. 2017), the MSE `shortcut` approach omits the step of the annual updating of the estimation model (assessment) in the feedback control. Instead, it emulates an annual update of the benchmark assessment model by passing outcomes ($SSB$ and $F$ or equivalents) from the 'true' age-structured dynamics of the operating model (OM), with assessment error, to the harvest control rule (HCR) and catch implementation system.

The HCRs are implemented using a simulated feedback control loop between the implementation system and the operating model, where the implementation system translates the emulated assessment outcome into the Total Allowable Catch (TAC) advice. The feedback control loop accounts for the lag between the last year of data used in the assessment and the implementation year of catch advice ($C_{adv}$).

For Antarctic krill in the Western Antarctic Peninsula (WAP), the implementation system of the harvest control rule is based on the assumption that advice is given for year $y+1$ based on an assessment completed in year $y$, using data available up to year $y-1$. The implementation of the derived $C_{adv}$ through the HCR therefore requires projection of stock dynamics via a short-term forecast. To do this, numbers-at-size (or -age) are projected through the year of assessment. Parameters such as recruitment, natural mortality ($M$), weight-at-size, and maturity are set as the mean of the last three years. A projection based on a fixed exploitation rate or fishing mortality corresponding to the last year ($y-1$) is used through to the implementation year ($y+1$).

The goal of this application is to test the robustness of the current harvest control rule used by CCAMLR for krill, which consists of a fixed TAC of 145,000 tonnes per year. The shortcut MSE approach facilitates this by reducing computational complexity and avoiding the need for annual full assessments, while still capturing feedback effects between advice and stock dynamics. Here, the MSE short-cut approach is implemented using the tools available in the Fisheries Library for R (FLR; Kell et al., 2007; [FLR Library](https://flr-project.org/) 

## Software Implementation

This analysis was conducted using R version `r R.version$major`.`r R.version$minor` [@R-base] with the following key packages:

1. Core MSE Framework: 
   - FLR ecosystem [@FLCore; @FLBRP] 
   - `mse` package [@mse-pkg] for management procedure evaluation

2. Stock Assessment:
   - SS3 integration via `r4ss` [@r4ss]
   - Simulation testing with `ss3sim` [@ss3sim]

3. Visualization & Reporting:
   - `ggplot2` [@ggplot2] for graphics
   - `kableExtra` [@kableExtra] for publication-ready tables

```{r package-versions, echo=FALSE, results='asis'}
pkgs <- c("FLCore", "mse", "FLBRP", "r4ss", "ss3sim", "ggplot2", "kableExtra")
vers <- sapply(pkgs, function(x) as.character(packageVersion(x)))

knitr::kable(
  data.frame(Package = pkgs, Version = vers),
  caption = "Key package versions used in analysis",
  booktabs = TRUE
) %>% kableExtra::kable_styling(latex_options = "hold_position")
```



## Glossary

The following glossary summarizes key HCR parameters and associated target and limit reference points
that are considered for tuning the candidate HCRs to optimise the trade-offs between maximising fishing
opportunity and risk:

+ $F_{MSY}$: target reference point for fishing mortality at Fmsy (or its proxy), (e.g. $F_{first year}$)

+ $B_{MSY}$: the average biomass around which the biomass fluctuated when fishing at $F_{MSY}$ or its proxy (e.g. $B_{35}$)

+ $B_{lim}$: a deterministic biomass limit reference point below which a stock is considered to have reduced reproductive capacity. Here $B_{lim}$ was set to $0.25B_{tgt}$ 

+ $B_{pa}$: a precautionary biomass reference point set with high probability that biomass is above $B_{lim}$, which acts as a safety margin below which the risk of reduced reproductive capacity is increasing. When the biomass is estimated to be above Bpa, the stock is considered to be within safe biological limits in terms of its reproductive capacity. 

+ $C_{adv}$: advised catch as output of the management procedure 

+ $B_{trigger}$: biomass trigger point of the HCR, specified as change point of biomass below which fishing mortality reduced relative to Ftgt. Btrigger is typically specified as ratio to $B_{MSY}$.


\pagebreak

# METHODOLOGY


## Operating Model developing

Build `FLStock` object.


```{r, eval=TRUE}
dir1 <- here("s1.4")
run = "krill.stock.wAP"
stk = window(ss3om::readFLSss3(dir1))
stk = simplify(stk)
# Fill NAs
stk@m.spwn[] = 0
stk@harvest.spwn[] = 0 
sr = ss3om::readFLSRss3(dir1,run)
stk@name = run
stk@desc = "2024, CCAMLR, SS3"
out = ss3om::readOutputss3(dir1)
#save(stk, sr, out, file = "base.model1.4.RData")
```


This code block initiates the setup of the operating model by reading and simplifying the stock and recruitment objects generated by the SS3 model. The working directory for the model outputs is specified (`dir1 <- here("s1.4")`), pointing to the folder that contains the SS3 output files. The main stock object (`stk`) is read using `ss3om::readFLSss3()`, and is then simplified using the `simplify()` function to remove unnecessary complexity. Missing values for the timing of spawning in both natural mortality and harvest are set to zero (`m.spwn[] = 0`, `harvest.spwn[] = 0`) to ensure consistency and completeness of the object. The recruitment object (`sr`) is read using `ss3om::readFLSRss3()`, and metadata for the stock object is updated for documentation purposes, indicating the model name and description, including year and source. Finally, all additional output files from SS3 (e.g., biomass, selectivity, fishing mortality) are read and stored in `out` using `ss3om::readOutputss3()`. This prepares the objects necessary for subsequent use in Management Strategy Evaluation (MSE) simulations.


```{r, eval=FALSE}
run = "krill.stock.wAP"
load(file=file.path("rdata",paste0(run,".rdata")),verbose = T)
```


```{r}
stka = stk
```

## Retune Stock-Recruitment

```{r}
# Extract SR pars
s = params(sr)[[1]]
R0 = params(sr)[[2]]
B0 = params(sr)[[3]]

# single sex
sr1 = srrTMB(as.FLSR(stka,
                     model=bevholtSV),
             spr0=mean(spr0y(stk)),
             r0.pr=c(R0,0.0001),
             s=s,
             s.est=F)
```

First, key parameters of the SR function are extracted from the recruitment object (`sr`), including `s` (shape or steepness parameters), `R0` (unfished recruitment), and `B0` (unfished spawning biomass). Then, a new SR relationship object (`sr1`) is created using the `srrTMB` function, which fits a Beverton-Holt stock-recruitment model with stochastic variation (denoted by the `bevholtSV` model). The input stock-recruitment data is converted to an `FLSR` object using `as.FLSR(stka)`. The `spr0` argument sets the unfished spawning potential ratio, calculated as the mean over years from the stock object (`stk`). The initial recruitment parameter `r0.pr` is initialized with `R0` and a small variance (0.0001). The `s` parameter is fixed (`s.est=F`) indicating it will not be estimated in this fit.

This retuning step ensures that the recruitment dynamics incorporated in the model reflect updated or refined parameter estimates for more realistic population projections in subsequent MSE simulations (Figure \@ref(fig:sr)).


```{r sr , message=FALSE,warning=FALSE,fig.width=6,fig.height=4, fig.cap = paste0("Comparison of stock stock-recruitment function from ss3 and retuned single-sex with FLSRTMB ") }
plotsrs(FLSRs(ss3=sr,
              sr=sr1))
```
Check that the `fbar` range is consistent with `ss.starter` input.

```{r}
range(stk)
```


Figure \@ref(fig:mainvar) displays key krill population and fishery variables for Management Strategy Evaluation (MSE), showing Spawning Stock Biomass (SSB) ranging from 0.00 to 0.12 (likely million tons), annual catch levels from 0 to 1.5 billion individuals, fishing mortality (F) for years 1990-2020, and recruitment (Rec) data across the same period, with the x-axis representing years on an unusual scale up to 160,000. The visualization illustrates relationships between reproductive biomass, harvest levels, fishing pressure, and population replenishment, enabling assessment of trade-offs between conservation goals (maintaining SSB) and fishery targets (sustaining catches) under different management scenarios in Antarctic krill fisheries.


```{r mainvar , message=FALSE,warning=FALSE,fig.height=6,fig.width=8, fig.cap = paste0("Seasonal  stock trajectories") }
plot(stk,
     metrics=list(SSB=function(x)unitSums(ssb(x)[,,,1]),
                  F=function(x)fbar(x),
                  Catch=function(x)catch(x),
                  Rec=function(x)unitSums(rec(x))))+
  theme_bw()+
  ylab("F")+
  xlab("Year")+
  facet_wrap(~qname,
             scales="free_y")
```

## Plot SS3 Stock Dynamics

Figure \@ref(fig:trayec)

```{r trayec, fig.height=5,fig.width=7, fig.cap = paste0("Stock assessment trajectories at age")}
plotdyn(stk)+
  theme_bw()+
  scale_color_viridis_d(option="E")
```

\newpage 

Figure \@ref(fig:trayec2)

```{r trayec2, fig.height=5,fig.width=7, fig.cap = paste0("Stock biology trajectories at age")}

plotbioyr(stk)+
  ggtitle(paste0(stk@name))+
  scale_color_viridis_d(option="E")

```

\newpage 

Figure \@ref(fig:trayec3)

```{r trayec3, fig.height=6, fig.cap = paste0("Annual stock quanties at age")}
plotbioage(stk)+
  theme(legend.position = "none")+
  scale_color_viridis_d(option="E")
```

\pagebreak

## Consistency checks using backtesting


```{r}
set.seed(123)
```

Get bias adjusted recruitment deviations from ss3 model.

The first code block processes recruitment deviations from an SS3 model output, applying bias adjustment to account for log-normal error structure. It then simplifies a seasonal stock assessment model (`stk`) into an annual, sex-structured format (`stka`) by aggregating seasonal data using weighted averages. If the original stock has multiple seasons, it converts the stock-recruitment relationship (`sr`) into an annual version (`sra`), ensuring compatibility with the simplified model. This step is crucial for MSE as it reduces computational complexity while preserving key biological dynamics.  

The second block extracts predicted recruitment (`pred_recr`) and bias-adjusted deviations from the SS3 output, converting them into an `FLQuant` object for use in FLR (Fisheries Library in R). The recruitment deviations are adjusted by subtracting bias and accounting for process error (`sigR`). If the stock is sex-structured (two units: F/M), the recruitment values are expanded accordingly. This ensures that recruitment variability is realistically incorporated into projections, maintaining the stock’s sex-specific dynamics when required.  

The third block performs forward simulations (`fwd`) to test the stock’s response under two management scenarios: (1) fixed catch (`testC`) and (2) fixed fishing mortality (`testF`). These projections use the adjusted recruitment (`recs`) and apply historical catch or F levels (excluding the first year to avoid initialization bias). This step evaluates how the stock would perform under different harvest strategies, a core component of MSE to compare trade-offs between yield and sustainability. The results help assess whether the model behaves as expected before full MSE simulations are run.

```{r}
if(dims(stk)$season>1){
stka = simplify(stk,'season',weighted = TRUE,harvest=TRUE)

discards.wt(stka) = stock.wt(stka)
stka@discards  =  computeDiscards(stka)
# Make annual sra
sra = sr
params(sra) = FLPar(an(sr@params[,1]),params=rownames(sr@params))
} else {
sra = sr1
stka = stk
}
```


```{r}
yrs = an(dimnames(stk)$year)
recruit = out$recruit[out$recruit$Yr%in%yrs,]
dms <- list(year = yrs)
sigR =  mean(an(out$sigma_R_info[1:2,"SD_of_devs_over_sigma_R"])) # Realised sigR
residuals <- FLQuant(exp(recruit$dev - 0.5 * recruit$biasadjuster *sigR^2), 
        dimnames = c(age = 0, dms), units = "")
recs = FLQuant(recruit$pred_recr, dimnames = c(age = 0, dms), units = "")


if (dims(stk)$unit == 2) recs <- expand(recs, unit = c("F", "M"))

```

```{r}
if (dims(stka)$unit == 3)
yrs = an(dimnames(stka)$year)
testC = fwd(stka,sr=recs[,ac(yrs[-1])],
  control=fwdControl(year=yrs[-1], value=(unitSums(catch(stka)[, ac(yrs[-1])])),
  quant="catch"))

testF = fwd(stka, sr=recs[,ac(yrs[-1])],
  control=fwdControl(year=yrs[-1], value=unitMeans(fbar(stka)[, ac(yrs[-1])]),
  quant="fbar"))
```

Figure \@ref(fig:hc1) generates a comparative diagnostic plot of three key model outputs—the original SS3-derived operating model (`ss3om=stka`), a catch-constrained forward projection (`backtestC=testC`), and an F-constrained projection (`backtestF=testF`)—to validate model consistency and performance before full MSE implementation. By comparing trajectories, this visualization helps identify potential structural mismatches (e.g., recruitment deviations, unrealistic biomass declines under catch limits) and ensures the simplified, sex-structured OM reliably replicates expected dynamics under different management scenarios, serving as a critical pre-MSE quality check to confirm the model's robustness for subsequent strategy evaluations.


```{r hc1, message=FALSE,warning=FALSE,fig.width=9,fig.height=7, fig.cap = paste0("Comparison of stock trajectories from ss3om and a backtest under the same Fbar") }

plot(window(FLStocks(ss3om=stka,
                     backtestC=testC,
                     backtestF=testF)))+
  theme_bw()+
  facet_wrap(~qname,scale="free_y")
```

(Note that minor deviations are likely due to difficulties in precisely adjusting the rec devs with bias correction)

## Estimate candidate reference points in krill fishery

Now, we obtain key biological reference points for krill fishery management, using outputs from an SS3 stock assessment model (stored in `out`). First, it calculates recruitment deviations (`maindevs`) and their autocorrelation (`rho`) along with process error (`sigmaR`). 

For MSY-based reference points, it extracts virgin SSB (unfished biomass) and scales it to estimate `Bmsy` (75% of virgin SSB), while `Fmsy` is taken either as a fixed low value (0.001) or derived from first F (e.g., `F_1997`) like assumtion of virginal condition. MSY is obtained directly from SS3 output, along with relative biomass (`B_MSY/SSB_unfished`). Uncertainty is quantified via CVs for SSB and F in the assessment year. The tuning grid defines precautionary thresholds: Blim, Bpa, and Btrigger are set at 20% of virgin SSB, while Feq (equilibrium F) uses recent fishery levels (F_2020) or a fixed value (0.018). The note highlights a discrepancy where the SS3-derived Fmsy (0.001) is lower than the empirical Feq (0.018), suggesting that the harvest control rule may be conservatively restricting fishing pressure below Btrigger, keeping realized F lower than the theoretical MSY level. These reference points form the basis for evaluating management strategies in subsequent MSE runs.

```{r}
# Main recdevs
recyrs = recruit$Yr[recruit$era =="Main"]
maindevs = unitSums(residuals[,ac(recyrs)])*2
rho = cor(maindevs [,-1],maindevs [,-length(maindevs)])
sigmaR = out$sigma_R_in

rho 
sigmaR

# MSY refpts
Bmsy <- out$derived_quants$Value[out$derived_quants$Label=="SSB_Virgin"]*0.75
#Fmsy <- 0.001
#or
Fmsy <- out$derived_quants$Value[out$derived_quants$Label=="F_1997"] # to star tt fishery
MSY <- out$derived_quants$Value[out$derived_quants$Label=="Dead_Catch_MSY"]
out$derived_quants$Value[out$derived_quants$Label=="B_MSY/SSB_unfished"]
# Short cut devs
ay = out$endyr # assessment year
SSBcv <- out$derived_quants$StdDev[out$derived_quants$Label==paste0("SSB_",ay)]/
  out$derived_quants$Value[out$derived_quants$Label==paste0("SSB_",ay)]

Fcv <- out$derived_quants$StdDev[out$derived_quants$Label==paste0("F_",ay)]/
  out$derived_quants$Value[out$derived_quants$Label==paste0("F_",ay)]

```

```{r}
#Blim=145000
Blim <- out$derived_quants$Value[out$derived_quants$Label=="SSB_Virgin"]*0.20

#Bpa=620000
Bpa <- out$derived_quants$Value[out$derived_quants$Label=="SSB_Virgin"]*0.20

#Btri.eq = 620000
Btri.eq <- out$derived_quants$Value[out$derived_quants$Label=="SSB_Virgin"]*0.20

#Feq =0.001  
#or 
Feq <- out$derived_quants$Value[out$derived_quants$Label=="F_2020"] #or Fstatus quo  (2020)
Fp05.eq =0.018

#or 
# > Fmsy # SS3
# [1] 0.001
# > Feq
# [1] 0.018
```

> Note that in this case the "true" $F_{MSY}$ as the property of the model is smaller than the $F_{MSY}$ derived from `EQsim`. This may be explained by the presence of the harvest control rule resulting in effective taking place, on average, below Btrigger.

```{r}
Fmsy # SS3
Feq
```

Function to find $B$ for $F$ at equilibrium

```{r}
fwdB4F = function(stock,sr,Fs=0.2,nfy=30){
    if (class(stock) == "FLStockR") {
      stock = as(stock, "FLStock")
    }
    fyrs = (dims(stock)$maxyear + 1):(dims(stock)$maxyear + nfy)
    nfy = length(fyrs)
    stkf = stf(stock, nfy)
    bx = do.call(c, lapply(an(Fs),function(x){
    ictrl = fwdControl(data.frame(year = fyrs, quant =  "fbar", value = x))
    out = fwd(stkf, sr = sr, control = ictrl)
    an(tail(unitSums(ssb(out))))
    }))
    
    data.frame(F=an(Fs),B=bx)
}

```

This function `fwdB4F` calculates the equilibrium biomass (B) corresponding to specific fishing mortality (F) levels for a krill stock. It works by:

1. Converting the input stock to a standard `FLStock` object if needed
2. Projecting the stock forward for 100 years (default) using the stock-recruitment relationship (sr)
3. Applying constant F values (default F=0.2) throughout the projection period
4. Returning the final equilibrium SSB (spawning stock biomass) reached under each F level

Key features:
- Uses FLR's forward projection (fwd) with fixed F control
- Handles multiple F values simultaneously via lapply
- Returns a dataframe linking each F value to its resulting equilibrium B
- Particularly useful for:
  - Deriving F vs B curves
  - Finding biological reference points
  - Testing equilibrium conditions in management strategy evaluation

The function essentially answers: *"What long-term biomass level would this stock stabilize at if we fished it constantly at F=X?"*.

This quiestion is fundamental for understanding stock dynamics and setting (or testing) sustainable harvest levels o krill

```{r}
Fx = c(rev(seq(0.1,1,0.1)))
#Fx = c(rev(seq(0.5,1,0.025)))
Ftgt = FLPar(c(Fmsy,Fx*Feq),
             params=c("Fmsy.om",
                      paste0(Fx,".Feq"))) 
Ftgt
```

This code creates a vector of fishing mortality (F) reference points for testing in Management Strategy Evaluation (MSE):

1. **F Value Generation**:
   - Creates a sequence of F values from 0.1 to 1 in 0.1 increments (0.1, 0.2,..., 1.0)
   - The values are reversed (`rev()`) to put them in descending order
   - (Commented alternative shows a finer resolution sequence from 0.5-1 by 0.025)

2. **Target F Values**:
   - Combines two types of reference points:
     1. `Fmsy` (maximum sustainable yield F from the operating model)
     2. Scaled versions of `Feq` (equilibrium F) multiplied by the sequence values (0.1*Feq, 0.2*Feq,..., 1.0*Feq)

3. **FLPar Object**:
   - Stores these values in an FLR parameter object (`FLPar`)
   - Labels them clearly with:
     - "Fmsy.om" for the MSY reference
     - "X.Feq" for the scaled equilibrium F values (where X is the multiplier)

This creates a comprehensive set of F targets that will allow testing of:
- The canonical MSY reference point
- A range of percentages of the equilibrium F
- Both conservative (low F) and aggressive (high F) fishing scenarios

The resulting `Ftgt` object can then be used in subsequent MSE simulations to evaluate how different fishing pressure levels affect stock sustainability and fishery performance.

```{r}
Bftgt = fwdB4F(stka,
               sra,
               Fs=Ftgt,
               nfy=30)
Bftgt
```

```{r, eval=FALSE, echo=FALSE}
save(Fx,
     Ftgt,
     Bftgt,
     file="rdata/ftune.sbr.rdata")
```

```{r,echo=F}
load(file="rdata/ftune.sbr.rdata")
```

Now, this `chunk` creates an `FLPar` object (`Ftgt.tune`) that combines both fishing mortality (F) and biomass (B) reference points for MSE tuning, merging the F targets from `Ftgt` (containing Fmsy and scaled Feq values) with their corresponding equilibrium biomass values from `Bftgt`. The resulting parameter object includes four distinct types of reference points: (1) the operating model's Fmsy ("Fmsy.om"), (2) a series of equilibrium F values at different fractions of Feq ("FeqX"), (3) the associated Bmsy ("Bmsy.om"), and (4) the corresponding biomass levels achieved at each Feq level ("BftgtX"). This comprehensive parameter set enables simultaneous evaluation of both fishing pressure and stock size thresholds during MSE testing, facilitating analysis of trade-offs between exploitation rates and biomass sustainability while maintaining the direct linkage between F and B reference points derived from the operating model's dynamics.


```{r}
Ftgt.tune = FLPar(c(Bftgt$F,Bftgt$B),
                  params=c("Fmsy.om",
                           paste0("Feq",Fx),
                           "Bmsy.om",
                           paste0("Bftgt",Fx))) 
```


```{r}
np = an(nrow(Ftgt.tune))
df = data.frame(
Tune = rownames(Ftgt.tune)[1:(np/2)],
Ftgt = round(an(Ftgt.tune)[1:(np/2)],3),
Btrigger = round(Btri.eq,1),
Btgt = round(an(Ftgt.tune)[(np/2+1):np],1),
"xB0" =  round(an(Ftgt.tune)[(np/2+1):np]/B0,3))
df$Btrigger[1] = 0
df$xB0 = round(df$xB0,2)
```

```{r}
kbl(df, 
    format = "latex",
    booktabs = TRUE,
    caption = "Option: Initial tuning grid with EQSIM Btrigger based on Feq tuning") %>%
  kable_styling(latex_options = c("hold_position", "striped"))

```


```{r}
refpts = FLPar(Fmsy = Fmsy,
               Feq = Feq,
               Bmsy = Ftgt.tune["Bmsy.om"],
               Beq = Ftgt.tune["Bftgt0.3"], 
               Blim = Blim,
               Bpa = Bpa,
               Btrigger = Btri.eq,
               B0 = B0,
               R0 = R0)
```


```{r}
refpts
```

(CHECK this!!!)

This step creates a consolidated `FLPar` object named `refpts` containing all key biological reference points for krill fishery management, derived from previous calculations. The object includes: fishing mortality at MSY (Fmsy = 0.0201), equilibrium fishing mortality (Feq = 0.0504), biomass at MSY (Bmsy = 1521660), equilibrium biomass at 30% Feq (Beq = 967,000), limit biomass (Blim = 406,000), precautionary biomass (Bpa = 406,000), biomass trigger (Btrigger = 406,000), virgin biomass (B0 = 2.03 million), and unfished recruitment (R0 = 369 million). These values reveal several important biological characteristics: (1) the equilibrium F (Feq) is approximately 2.5 times higher than Fmsy, suggesting the operating model's MSY is more conservative than empirical equilibrium conditions, (2) all precautionary biomass thresholds (Blim, Bpa, Btrigger) are set at 20% of B0, indicating a risk-averse management approach, and (3) the close proximity of Bmsy and Beq (953k vs 967k) suggests the stock exhibits relatively stable biomass across a range of fishing pressures. These reference points will serve as critical benchmarks for evaluating management strategies in subsequent MSE simulations.

## Create `FLStockR` with `@refpts`

- Centralized Management Parameters
By storing reference points (e.g., Fmsy, Btrigger, Blim) directly within the stock object, we ensure all biological and management benchmarks travel with the data. This avoids mismatches between projections and rules during MSE simulations.

- Dynamic Harvest Control Rules (HCRs)
The FLStockR class natively supports HCRs that reference @refpts (e.g., "reduce F if SSB < Btrigger"). This automates compliance with predefined management procedures during forward projections.

- Consistency in MSE Testing
Simulations can dynamically access refpts (e.g., to scale F based on Fmsy or check biomass against Bpa), ensuring all strategies are evaluated against the same benchmarks.

- Reproducibility and Transparency
Embedding reference points directly into the stock object documents the exact thresholds used, critical for peer review or management negotiations.


```{r}
stkr = FLStockR(stka) # Convert FLStock to FLStockR 
stkr@refpts = refpts  # Attach reference points  
```

Summarize short-cut params. Create a consolidated `FLPar` object named `spars` containing key shortcut parameters for krill stock dynamics: natural mortality fraction (`s`), recruitment process error (`sigmaR`), recruitment autocorrelation (`rho`), fishing mortality observation error (`Fcv`), and spawning stock biomass observation error (`SSBcv`). These parameters collectively define critical stochastic elements in the operating model, where `sigmaR` and `rho` characterize recruitment variability patterns, while `Fcv` and `SSBcv` quantify uncertainty in observed fishery and biomass data - together they form the core environmental and observation noise components needed to generate realistic simulations in Management Strategy Evaluation.

```{r}
spars = FLPar(s=s,
              sigmaR=sigmaR, 
              rho=rho,
              Fcv=Fcv,
              SSBcv=SSBcv)
```


Figure \@ref(fig:timedyb) displays four key time series panels tracking krill population and fishery dynamics from 1990 to 2020: Recruitment shows high interannual variability (0-1.5 billion individuals) with no clear trend; Fishing mortality (F) declined steadily from 0.12 to near-zero; Spawning Stock Biomass (SSB) decreased from 2 million to approximately 500,000 units, with reference points (Bmsy, Beq, Btrigger, Bpa, Blim) marked for management context; while Catches (not fully visible) appear to follow annual fluctuations. The inverse relationship between declining F and stabilizing SSB suggests effective management intervention, though recruitment variability remains a critical uncertainty factor in population recovery.

```{r timedyn, message=FALSE,warning=FALSE,fig.height=7,fig.width=9, fig.cap = paste0("Status Advice plot  showing stock trajectories of Recruitment, $SSB$, $F$, recruitment and $Yield$") }
plotAdvice(stkr)
```
And now, we saves eight key objects into an RData file (`om.ss3ref.sbr.rdata`) that collectively form a complete **Operating Model (OM)** for krill management strategy evaluation:  

1. **Stock objects**:  
   - `stk` (original seasonal FLStock)  
   - `stka` (simplified annual version)  
   - `stkr` (sex-structured version)  

2. **Reference points**:  
   - `refpts` (Fmsy, Btrigger, etc.)  

3. **Stock-recruitment relationships**:  
   - `sr` (seasonal) and `sra` (annual)  

4. **Process/observation error parameters**:  
   - `spars` (sigmaR, rho, Fcv, SSBcv)  

This bundle preserves all SS3-derived inputs needed to run MSE simulations while maintaining consistency between biological parameters, stock structure, and management rules. The "ss3ref.sbr" filename suggests this OM uses SS3 reference points with sex-structured (s), biomass (b), and recruitment (r) components.

```{r eval=FALSE}
save(stk,
     stka,
     stkr,
     refpts,
     sr,
     sra,
     spars,
     file="rdata/om.ss3ref.sbr.rdata") 
```

## Set up short-cut MSE

Load `OM` conditioned to Stock Synthesis and more.

```{r}
load("rdata/om.ss3ref.sbr.rdata",verbose=T)
```

Next set up the MSE horizon

```{r}
# data year
dy <- dims(stka)$maxyear
# FINAL year
fy <- dy+10
# assessment year
ay = dy+1
# intermediate years
iy = ay
```

For sciences objective research in krill fishery, the number of iterations are reduced to 100.

```{r}
it <- 100
```



This code prepares a reduced set of 100 simulated stock iterations (from an original 1000) for computational efficiency in Management Strategy Evaluation (MSE) by using the `propagate()` function on the annual stock object (`stka`). The subsetting to 100 iterations (`it=100`) maintains stochasticity while reducing runtime, which is particularly useful for testing and debugging scenarios before running full-scale MSE simulations. The resulting object `stki` preserves all biological and structural properties of the original stock but with fewer stochastic realizations.


```{r}
stki = propagate(stka,
                 it)
```

The second part generates autocorrelated recruitment deviations using an AR1 lognormal process (`rlnormar1`), incorporating the previously defined process error magnitude (`sigmaR`) and temporal correlation (`rho`) from the `spars` object. These deviations account for natural variability in recruitment across the projection years (from `dy` to `fy`). For sex-structured models (when `unit=2`), the deviations are expanded to separately affect female ("F") and male ("M") recruitment, ensuring biological realism in sexually dimorphic species. These simulated recruitment patterns will drive population dynamics in forward projections, reflecting realistic environmental variability while maintaining consistency with the stock's historical recruitment characteristics.

```{r}
srdevs <- FLCore::rlnormar1(n=it,
                    sdlog=spars["sigmaR"],
                    rho=spars["rho"], 
                    years=seq(dy, fy))
# Sex-structured
if (dims(stki)$unit == 2) srdevs  <- expand(srdevs ,
                                            unit = c("F", "M"))
```


Now construct the `FLom` object from the `mse` package by passing on `FLStock`,`refpts`, `sr` and the method used for foward projections.


This code constructs the final Operating Model (OM) object (`FLom`) for Management Strategy Evaluation (MSE) by integrating all key components:

1. Core elements:
- `stock=stki`: The propagated FLStock with 100 iterations (reduced from 1000 for efficiency)
- `refpts=refpts`: Biological reference points (Fmsy, Btrigger, etc.)
- `sr=sra`: Annual stock-recruitment relationship

2. Projection configuration:
- Uses `mseCtrl` to specify `fwd.om` as the forward projection method
- Incorporates pre-generated recruitment deviations (`srdevs`) with AR1 autocorrelation

3. Key features:
- Maintains sex-structure if present in `stki`
- Embeds both deterministic (SR relationship) and stochastic (deviations) elements
- Links reference points directly to projection rules

The resulting `om` object is a self-contained, ready-to-simulate operating model that:
- Can run multiple management scenarios
- Preserves biological realism through structured recruitment variability
- Automatically applies reference points during projections
- Serves as the foundation for subsequent MSE testing of harvest control rules

This represents the final step in OM construction before implementing actual management strategy evaluations.


```{r}
om <- FLom(stock=stki,
           refpts=refpts, 
           sr=sra,
           projection=mseCtrl(method=fwd.om),
           deviances=srdevs)

om
```
The `FLom` object represents a fully parameterized operating model for krill population dynamics, covering ages 0-7+ across 30 years (1991-2020) with 100 stochastic iterations. The stock shows substantial recruitment variability (2.0 million to 1.9 billion individuals), with spawning biomass (SSB) ranging 286-1,418 metric tons and catches peaking at 155,542 tons under fishing mortality (F) levels of 0-0.12. The Beverton-Holt stock-recruitment relationship (a=385.8M, b=46,709) governs population replenishment, while reference points include Fmsy (0.020), Feq (0.050), Bmsy (952,691t), and precautionary thresholds (Btrigger=Bpa=Blim=405,776t). The projection method `mse::fwd.om` will use these biological benchmarks and the observed recruitment variability (2.0e+06 - 1.9e+09) to simulate management scenarios, where the 40% virgin biomass (B0=2.03M t) serves as the unfished baseline for sustainability evaluations.

\pagebreak

Next add the structure for the future years: average of last 3 years

```{r}
om <- fwdWindow(om, 
                end=fy)
```

> Next, a so called observation error is constructed. In the case of the short-cut MSE, it simply holds the "perfect" stock information. For a full MSE with inbuilt estimation model  it would also generate the observations with errors, such a catch-at-age and survey numbers at age for SAM or a4a, or biomass surveys indices and catches for SPiCT or JABBA.  

```{r tidy=FALSE}
oem <- FLoem(
  observations=list(stk=stock(om)),
  method=perfect.oem
)
```

However, there is increasing realisation that the assessment estimates are imperfect. Therefore, ICES has implemented procedures to add uncertainty about the key quantities $F$ and $SSB$, where the error on $F$ is specified by a the random error term $Fcv$ and a first order autocorrelation parameter $Fphi$ and the precision of $SSB$ can specified by $SSBcv$ 


## Short-cut deviations

The `shortcut_devs()` function generates observation error deviations for the operating model (om) by incorporating pre-defined levels of uncertainty in fishing mortality (Fcv) and spawning stock biomass (SSBcv), with an added autocorrelation parameter (Fphi=0.5) for F. These shortcut deviations simulate realistic monitoring uncertainty - where Fcv represents interannual variability in fishery data quality, SSBcv reflects biomass estimation error in surveys/assessments, and the autocorrelation accounts for persistent biases in F reporting. This creates stochastic but ecologically plausible observation scenarios that will affect management decisions during MSE runs, as managers only "see" the error-prone versions of F and SSB.

```{r tidy=FALSE}
sdevs <- shortcut_devs(om, 
                       Fcv=spars["Fcv"], 
                       Fphi=0.5, 
                       SSBcv=spars["SSBcv"])
```

Finally, the implementation error module `iem` is setup. In this case, with a random catch implementation error of 10%.

The `FLiem()` function  configures Implementation Error (iem) through a 10% lognormal catch deviation (rlnorm(..., 0.1)), using the noise.iem method to simulate imperfect quota adherence. In krill could be lower, but we leave this percentage. 

This captures real-world discrepancies between advised and actual catches, where positive/negative errors represent overfishing or underharvest situations respectively. The error is applied proportionally across all 100 iterations (it) while maintaining a mean of zero (no systematic bias), reflecting random implementation variability rather than consistent over/underperformance. Together, these modules ensure the MSE evaluates management procedures under realistic conditions of both scientific uncertainty (observation errors) and operational imperfections (implementation errors).

```{r}
iem <- FLiem(method=noise.iem,
  args=list(noise=rlnorm(it, rec(om) %=% 0, 0.1)))
```


And now, we save previous object. This code saves four critical components of the Management Strategy Evaluation (MSE) framework into an R data file (`flom.sbr.rda`):

1. `om` (Operating Model): Contains the simulated krill population dynamics including:
   - Stock structure (ages 0-7+, years 1991-2020)
   - Biological parameters (growth, mortality)
   - Reference points (Fmsy, Btrigger, etc.)
   - Recruitment variability patterns

2. `oem` (Observation Error Model): Stores the configuration for simulating:
   - Scientific uncertainty in monitoring data
   - Observation errors for key indicators like SSB and F

3. `sdevs` (Shortcut Deviations): Pre-generated error terms that will be applied during simulations to create:
   - Realistic observation noise
   - Autocorrelated monitoring errors

4. `iem` (Implementation Error Model): Contains the rules for:
   - Simulating imperfect quota adherence
   - Random catch deviations (+/- 10%)

The filename `flom.sbr.rda` suggests this package represents:
- An FLR-based (`fl`) operating model (`om`)
- With sex-structured (s), biomass (b), and recruitment (r) components
- In ready-to-use R data format (`.rda`)

The components work together to create a realistic simulation environment where management procedures can be tested under conditions that mirror real-world uncertainties and implementation challenges.

```{r,eval=FALSE}
save(om, 
     oem,
     sdevs,
     iem,
     file="rdata/flom.sbr.rda")
```

```{r,echo=FALSE}
load(file="rdata/flom.sbr.rda")
```

## Setting up harvest control rules


This can be effectively implemented ICES advice rule hockey-stick by setting the $B_{trigger}$ to zero, using the `icesControl` function. This function can also take the `SSBdevs` and `Fdevs` that implement the deviations from the SSB and F with aim to account for assessment errors.


### `shortcut.sa2()` function description

The function `shortcut.sa2()`is a simple implementation of a stock assessment shortcut rule. It generates an index (ind) based on spawning stock biomass (SSB), adjusted by a set of deviates (SSBdevs) over a given time window. This index is then used to update the tracking object to reflect convergence for the assessment year (`ay`).


\[
\texttt{ind}_{\text{SSB}}(y) = \left( \sum_{i} \text{SSB}_i(y) \right) \times W(y; y_0, \Delta y)
\]

where :

- $\sum_{i} \text{SSB}_i(y)$ representa la suma de SSB sobre todas las unidades
- $W(y; y_0, \Delta y)$ es una función de ventana centrada en $y_0$ con ancho $\Delta y$

and follow convergency

\[
\texttt{tracking}_{\text{conv.est}}(\text{ay}) = 1
\]


```{r}
shortcut.sa2 <- function(stk, 
                         idx, 
                         SSBdevs=unitSums(ssb(stk)) %=% 1, 
                         args, 
                         tracking, 
                         ...) {
  # DIMS
  y0 <- args$y0
  dy <- args$dy
  ay <- args$ay
  it <- args$it

  # SUBSET oem stock
  stk <- window(stk, end=dy)

  ind <- FLQuants(
    # SSB + devs 
    #><> add unitSums
    ssb=unitSums(ssb(stk)) * window(SSBdevs, 
                                    start=y0, 
                                    end=dy))

  track(tracking, "conv.est", ac(ay)) <- 1

  list(stk=stk, ind=ind, tracking=tracking)
}
```

### `TAC.IS2` Function Description

This function implements an **Interim Setting (IS) TAC (Total Allowable Catch) rule** for fisheries management, combining short-term forecasting with decision rules to set catch limits based on stock status.


The geometric mean recruitment is computed over selected years:
\[
\overline{R} = \exp\left(\text{yearMeans}\left(\log\left(\sum_{\text{units}} R_{y}\right)\right)\right), \quad y \in \text{recyrs}
\]
where:
- \( R_y \) = recruitment in year \( y \)
- `recyrs` = specified years (all series)

The target \( F \) is adjusted by deviations (`Fdevs`):
\[
F_{\text{target}} = F_{\text{ref}} \times \delta_F
\]
where:
- \( F_{\text{ref}} \) = reference \( F \) from `ctrl`
- \( \delta_F \) = deviation multiplier (default = 1)

The final TAC is bounded by interannual change limits:
\[
\text{TAC}_{\text{final}} = 
\begin{cases}
\min(\text{TAC}_{\text{projected}}, \text{TAC}_{\text{prev}} \times \delta_{\text{upp}}}), & \text{if } \delta_{\text{upp}} \text{ specified} \\
\max(\text{TAC}_{\text{projected}}, \text{TAC}_{\text{prev}} \times \delta_{\text{low}}}), & \text{if } \delta_{\text{low}} \text{ specified} \\
\text{TAC}_{\text{projected}}, & \text{otherwise}
\end{cases}
\]
where:
- \( \delta_{\text{upp}} \) = upper bound (e.g., 1.2 = +20% max increase)
- \( \delta_{\text{low}} \) = lower bound (e.g., 0.8 = -20% max decrease)


The stock is projected using:
\[
N_{y+1} = N_y e^{-Z_y} + R_{y+1}
\]
\[
C_y = \frac{F_y}{Z_y} (1 - e^{-Z_y}) N_y
\]
where:
- \( N \) = population numbers
- \( Z = F + M \) (total mortality)
- \( C \) = catch


This function is useful for interim catch settings in fisheries where full assessments are not available annually. It ensures gradual TAC adjustments while accounting for recent recruitment trends.


```{r eval=FALSE, echo=FALSE}
# TAC from HW
tac.is2 <- function(stk, 
                    ctrl,
                    args, 
                    output="catch",
                    recyrs=-2,
  Fdevs=unitMeans(fbar(fut)) %=% 1, 
  dtaclow=NA, 
  dtacupp=NA, 
  fmin=0, 
  reuse=TRUE,
  initac=metrics(stk, output)[, ac(iy - 1)], tracking) { 
  # EXTRACT args
  spread(args)


  # SET control years
  cys <- seq(ay + management_lag, ay + management_lag + frq - 1)

  # PREPARE stk for cys, biology as in last nsqy years
  fut <- fwdWindow(stk, end=cys[length(cys)], nsq=nsqy)

  # PARSE recyrs if numeric
  id <- dimnames(stk)$year

  # COERCE to list
  if(!is.list(recyrs)) {
    recyrs <- list(recyrs)
  }
  
  # PARSE list
  for(i in recyrs) {
    if(is(i, 'character')) {
      id <- id[!id %in% i]
    } else if(all(i < 0)) {
      if(length(i) == 1)
        id <- rev(rev(id)[-seq(abs(i))])
      else
        id <- rev(rev(id)[i])
    } else if(all(i > 0)) {
      id <- rev(rev(id)[seq(abs(i))])
    }
  }

  # SET years to use
  recyrs <- id

  # CHECK recyrs
  if(!all(recyrs %in% dimnames(stk)$year)) {
    stop("'recyrs' cannot be found in input stk")
  }

  # TODO: OTHER rec options
  
 
  # SET GM recruitment from past
  #><> add unitSums()
  gmnrec <- exp(yearMeans(log(unitSums(rec(stk))[, recyrs])))

  # SETUP SRR
  srr <- predictModel(model=rec~a, params=FLPar(a=gmnrec))

  # STORE geomeanrec value 
  track(tracking, "gmrec.isys", ay + management_lag) <- gmnrec

  # ADD F deviances for 1 year

  # reuse = TRUE
  if(isTRUE(reuse) | toupper(reuse) == 'F') {
    ftar <- rep(c(ctrl[1,]$value * Fdevs[, ac(cys[1])]), length(cys))
  # reuse = FALSE
  } else {
    ftar <- c(ctrl$value * Fdevs[, ac(cys)])
  }

  # TRACK Ftarget
  track(tracking, "fbar.isys", cys) <- ftar

  # FORECAST for iyrs and my IF mlag > 0,
  if(management_lag > 0) {
 
    # SET F for intermediate year #><> added unitMeans
    #><> add unitMeans()
  
    fsq <- unitMeans(fbar(stk))[, ac(dy)]

    # TODO: ADD TAC option

    # CONSTRUCT fwd control
    fctrl <- fwdControl(
      # ay as intermediate with Fsq TODO: Other options
      list(year=seq(ay - data_lag + 1, length=management_lag),
        quant="fbar", value=rep(c(fsq), management_lag)),
      # target
      list(year=cys, quant="fbar", value=c(ftar))
    )

  # else only for my
  } else {
    fctrl <- fwdControl(
      list(year=ay + management_lag, quant="fbar", value=ftar))
  }

  # RUN STF ffwd
  fut <- ffwd(fut, sr=srr, control=fctrl)

  # ID iters where hcr set met trigger and F > fmin
  id <- c(tracking[[1]]["decision.hcr", ac(ay)] > 2) &
    c(unitMeans(fbar(fut))[, ac(ay + management_lag)] > fmin)

  # EXTRACT catches
  if(isTRUE(reuse) | toupper(reuse) == "C") {
    TAC <- expand(unitSums(catch(fut))[, ac(cys)[1]], year=seq(length(cys)))
  } else {
    TAC <- unitSums(catch(fut))[, ac(cys)]
  }

  # GET TAC dy / ay - 1
  if(ay == iy)
    prev_tac <- rep(c(initac), length=args$it)
  else
    prev_tac <- c(tracking[[1]]["isys", ac(ay)])

  # APPLY upper and lower TAC limit, if not NA and only for id iters
  if(!is.na(dtacupp)) {
    iter(TAC, id) <- pmin(c(iter(TAC, id)), prev_tac[id] * dtacupp)
  }
  if(!is.na(dtaclow)) {
    iter(TAC, id) <- pmax(c(iter(TAC, id)), prev_tac[id] * dtaclow)
  }

  # CONSTRUCT fwdControl
  # TODO: USE frq here
  ctrl <- fwdControl(lapply(seq(length(cys)), function(x)
    list(year=cys[x], quant=output, value=TAC[,x])))
    
  return(list(ctrl=ctrl, tracking=tracking))
}
```


```{r eval=TRUE, echo=FALSE}
# TAK with all recruit series ad hoc (Made with AI)
tac.is2 <- function(stk, 
                    ctrl,
                    args, 
                    output = "catch",
                    recyrs = "all",  # Changed default to use all years
                    Fdevs = unitMeans(fbar(fut)) %=% 1, 
                    dtaclow = NA, 
                    dtacupp = NA, 
                    fmin = 0, 
                    reuse = TRUE,
                    initac = metrics(stk, output)[, ac(iy - 1)], 
                    tracking) { 
  
  # EXTRACT arguments
  spread(args)
  
  # SET control years
  cys <- seq(ay + management_lag, ay + management_lag + frq - 1)
  
  # PREPARE stock for projection
  fut <- fwdWindow(stk, end = cys[length(cys)], nsq = nsqy)
  
  # HANDLE recruitment years specification
  if (identical(recyrs, "all")) {
    # Use all available years in the stock
    recyrs <- dimnames(stk)$year
  } else if (is.numeric(recyrs)) {
    # Convert negative indices to positive year references
    all_years <- dimnames(stk)$year
    if (all(recyrs < 0)) {
      recyrs <- tail(all_years, n = abs(recyrs[1]))
    } else {
      recyrs <- all_years[recyrs]
    }
  }
  
  # VALIDATE recruitment years
  if (!all(recyrs %in% dimnames(stk)$year)) {
    stop("Specified recruitment years not found in stock object")
  }
  
  # CALCULATE geometric mean recruitment across all selected years
  gmnrec <- exp(mean(log(unitSums(rec(stk)[, recyrs])), na.rm = TRUE))
  
  # SETUP stock-recruitment relationship (constant mean recruitment)
  srr <- predictModel(model = rec ~ a, params = FLPar(a = c(gmnrec)))
  
  # STORE geometric mean recruitment in tracking
  track(tracking, "gmrec.isys", ay + management_lag) <- gmnrec
  
  # SET target F values
  if (isTRUE(reuse) | toupper(reuse) == 'F') {
    ftar <- rep(ctrl[1, ]$value * Fdevs[, ac(cys[1])], length(cys))
  } else {
    ftar <- c(ctrl$value * Fdevs[, ac(cys)])
  }
  
  # TRACK target F values
  track(tracking, "fbar.isys", cys) <- ftar
  
  # HANDLE management lag
  if (management_lag > 0) {
    fsq <- unitMeans(fbar(stk))[, ac(dy)]
    
    fctrl <- fwdControl(
      list(
        year = seq(ay - data_lag + 1, length = management_lag),
        quant = "fbar", 
        value = rep(fsq, management_lag)
      ),
      list(
        year = cys, 
        quant = "fbar", 
        value = ftar
      )
    )
  } else {
    fctrl <- fwdControl(
      list(
        year = ay + management_lag, 
        quant = "fbar", 
        value = ftar
      )
    )
  }
  
  # RUN forward projection
  fut <- ffwd(fut, sr = srr, control = fctrl)
  
  # IDENTIFY valid iterations
  id <- c(tracking[[1]]["decision.hcr", ac(ay)] > 2) &
    c(unitMeans(fbar(fut))[, ac(ay + management_lag)] > fmin)
  
  # EXTRACT catches
  if (isTRUE(reuse) | toupper(reuse) == "C") {
    TAC <- expand(unitSums(catch(fut))[, ac(cys)[1]], year = seq(length(cys)))
  } else {
    TAC <- unitSums(catch(fut))[, ac(cys)]
  }
  
  # GET previous TAC
  prev_tac <- if (ay == iy) rep(initac, length = args$it) else c(tracking[[1]]["isys", ac(ay)])
  
  # APPLY TAC constraints
  if (!is.na(dtacupp)) iter(TAC, id) <- pmin(c(iter(TAC, id)), prev_tac[id] * dtacupp)
  if (!is.na(dtaclow)) iter(TAC, id) <- pmax(c(iter(TAC, id)), prev_tac[id] * dtaclow)
  
  # CONSTRUCT final control object
  ctrl <- fwdControl(lapply(seq(length(cys)), function(x) {
    list(
      year = cys[x], 
      quant = output, 
      value = TAC[, x]
    )
  }))
  
  return(list(ctrl = ctrl, tracking = tracking))
}
```


However, these rules originate from ICES; for krill, we will test the fixed quota catch rule for subarea 48.1, which is set at 145,000 tonnes, using the following arrangement:

```{r eval=FALSE}
fixedTAC_hcr <- function(stk, ctrl, args, tracking) {
  # Obtener número de iteraciones del stock de entrada
  niter <- dims(stk)$iter
  
  # Crear FLQuant con dimensiones correctas
  tac <- FLQuant(145000,
                dimnames = list(year = args$iy,
                               iter = 1:niter))
  
  # Crear control asegurando compatibilidad
  ctrl <- fwdControl(
    data.frame(
      year = args$iy,
      quant = "catch",
      value = c(tac),
      iter = 1:niter)
  )
  
  return(list(ctrl = ctrl, tracking = tracking))
}

```






The next code configures a three-step Management Procedure (MP) using the `mpCtrl` framework for krill MSE testing:  

1. Estimation (`est`): Uses the `shortcut.sa` method with SSB deviations (`sdevs$SSB`) to simulate assessment errors, generating biased stock estimates that mimic real-world uncertainty.  
2. Harvest Control Rule (`hcr`): Implements a hockey-stick HCR where fishing mortality (`fbar`) is set to zero below a 1% SSB trigger (`trigger=0.01`) and gradually increases to `Fmsy` as SSB recovers, with no minimum biomass threshold (`lim=0`).  
3. Implementation (`isys`): Converts the HCR's F target into TACs using `tac.is`, incorporating autoregressive F deviations (`sdevs$F`) to simulate quota implementation errors, while using a 2-year recruitment average (`recyrs=-2`) for projections.  

This structure replicates an ICES-style precautionary approach, testing how the stock responds to management under combined assessment, control rule, and implementation uncertainties.

```{r}
arule <- mpCtrl(list(
  # (est)imation method: shortcut.sa + SSB deviances
  est = mseCtrl(method=shortcut.sa,
    args=list(SSBdevs=sdevs$SSB)),

  # hcr: hockeystick (fbar ~ ssb | lim, trigger, target, min)
  hcr = mseCtrl(method=hockeystick.hcr,
    args=list(lim=0, trigger=0.01, target=Fmsy,
    min=0, metric="ssb", output="fbar")),

  # (i)mplementation (sys)tem: tac.is (C ~ F) + F deviance
  isys = mseCtrl(method=tac.is,
    args=list(recyrs=-2, fmin=0, Fdevs=sdevs$F))
  ))
```


```{r eval=FALSE}
#para krill
# Configurar el mpCtrl con la nueva regla
arule_fixedTAC <- mpCtrl(list(
  est = mseCtrl(method = shortcut.sa),  # Método de evaluación (sin cambios)
  hcr = mseCtrl(method = fixedTAC_hcr), # Nueva regla de TAC fijo
  isys = mseCtrl(method = tac.is)       # Implementación (sin cambios)
))
```


This rule can now be run passing on the `om`, `oem` and `arule` and an additional argument to set the implementation year to 2020.


```{r, eval=FALSE, echo=FALSE}
#(dont Run in krill!!!)
mseargs <- list(iy=dy,
                fy=fy, 
                data_lag=1, 
                management_lag=1, 
                frq=1)

load(file="rdata/mps.ftune.sbr1000.rdata",
     verbose=T)

mp.fixexFmsy = stks$Fmsy.OM

```

This code executes the Management Strategy Evaluation (MSE) simulation using the configured components:  

Runtime Setup:  
   - `mseargs` defines key temporal parameters:  
     - `iy`/`fy`: Initial/final projection years  
     - `data_lag=1`: 1-year delay in data availability  
     - `management_lag=1`: 1-year delay in management implementation  
     - `frq=1`: Annual management updates  

MSE Execution:  
   - `mp()` runs the simulation using:  
     - The operating model (`om`)  
     - Observation error model (`oem`)  
     - Control rules (`arule`)  
   - `verbose=T` prints progress updates  

Output Handling:  
   - Stores runtime metrics via `system.time()`  
   - Saves the simulated stock trajectories in `mp.fixexFmsy` for analysis  
   - The `@om@stock` slot contains the projected stock states under the tested HCR  

This represents the **core MSE workflow**, testing how the hockey-stick HCR performs under realistic lags and uncertainties. The results enable evaluation of trade-offs between conservation and yield objectives.

```{r,warning=FALSE}
mseargs <- list(iy=dy,
                fy=fy, 
                data_lag=1, 
                management_lag=1, 
                frq=1)

system.time(
run <- mp(om, 
          oem=oem, 
          ctrl=arule, 
          args=mseargs,
          verbose=T)
)

mp.fixexFmsy = run@om@stock
```


```{r eval=FALSE}
#testing krill TAC fixed
# 2. Configurar MSE
mseargs <- list(
  iy = 2030,
  fy = 2035,
  frq = 1,
  management_lag = 1,
  data_lag = 1
)

# 3. Ejecutar
run_fixed <- mp(
  om = om,
  oem = oem,
  ctrl = arule_fixedTAC,
  args = mseargs,
  parallel = TRUE
)
```

\pagebreak

# RESULTS

The Figure \@ref(fig:fig9) demonstrate the population and fishery response of Antarctic krill under different management scenarios from 1990-2030. Recruitment shows high natural variability (0-1.5 billion individuals) without directional trends, while spawning biomass (SB) declined significantly from 3 million units to 1 million between 1990-2010 before stabilizing under management. The fishing mortality (F) trajectory reveals that the fixedFmsy scenario successfully maintained F below 0.03 after 2020 - a substantial reduction from peak historical levels of 0.12 - while still supporting stable catch levels. This suggests the krill stock can sustain moderate catches when managed at Fmsy, as evidenced by the biomass stabilization at about 1-2 million units post-2020 despite the highly variable recruitment. The fixedFmsy approach appears effective at balancing conservation (maintaining SB above precautionary thresholds) and fishery objectives (consistent catches), though the population's inherent recruitment variability remains a key determinant of longer-term sustainability. The parallel trends in catch and biomass under fixedFmsy management indicate the stock may be operating within sustainable limits, though continued monitoring of recruitment-SB relationships would be prudent given the species' ecological importance in Antarctic ecosystems.

The plot compares two management scenarios for Antarctic krill:

- Status Quo (stock): Shows historical patterns with F reaching 0.12 and biomass declining to ~1 million tons by 2010, reflecting unregulated fishing pressure.

- Fixed Fmsy Management: Demonstrates effective control with:
F maintained at major o equal 0.03 after 2020
Biomass stabilized at 1-2 million tons
Catches sustained without collapse
Recruitment variability maintained within natural ranges

```{r fig9, fig.height=7,fig.width=9,warning=FALSE,message=FALSE, fig.cap = paste0("Initial OM and the MSE forecast horizon under a fixed $F_{tgt}$ rule")}
# make FLStocks from om until 2020 (implementation) and the run 
stk.fmsy = FLStocks(stock=window(om@stock,end=dy),
              fixedFmsy=mp.fixexFmsy)

plot(stk.fmsy)+
  facet_wrap(~qname,
             scales="free")+
  theme_bw()+
   geom_vline(xintercept = c(dy),
              linetype=2,col=1)+
  geom_vline(xintercept = c(fy),
             linetype=2,col=4)

```

The `run` can also be appended to the `om` to make a single `FLStockR` object with reference points

```{r}
runR = FLStockR(append(window(om@stock,
                              end=dy),
                       mp.fixexFmsy))
runR@refpts=refpts
```

This allows to quickly evaluate the stock status under a fixed $F_{MSY}$ rule.

It can be seen that despite "perfect" knowledge of the "true" $F_{MSY}$, and fishing pressure is on average $F_{MSY}$, the stock fails to attain biomass levels at $B_{MSY}$ with a relative high risk to fall below $B_{lim}$. This is a well known fact as a result of the lags between data and management and asymetric risks in that exceeding $F_{MSY}$ is more consequential on both $SSB$ and long term yield, then fishing below $F_{MSY}$, In the case of the latter, more biomass is left in the water, which provides increased future reproduction potential and catch opportunity (Figure \@ref(fig:statusfi)).   

```{r statusfi, fig.height=7,fig.width=9,warning=FALSE,message=FALSE, fig.cap = paste0("Stock Status under a fixed $F_{tgt}$ short-cut MSE rule")}
thin = seq(1,it,5)
plotAdvice(iter(runR,thin))+
     geom_vline(xintercept = c(dy),
                linetype=2,col=1)+
    geom_vline(xintercept = c(fy),
               linetype=2,col=4)+
  scale_x_continuous(breaks=seq(1970,3000,5))+
  theme_bw()+
  theme(axis.text.x = element_text(size=8,
                                   angle=90,
                                   vjust=0.5))
```

Even relatively simplified short-cut MSE frameworks provide a powerful to explore alternative HCRs to achieve better trade-off between risks and yield. 

Figure \@ref(fig:fixed) show the c current control rule based in a contsant catch limit in F asociated


```{r hfixed, fig.height=3,fig.width=5,warning=FALSE,message=FALSE, fig.cap = paste0("Advice Rule Current in Krill")}
 plotGFCM(fadv = Feq,
          btrigger =Btri.eq,
          bthr = -1,
          ftgt = Feq,
          btgt=df$Btgt[2],
          blim=an(refpts["Blim"]),
          fmin=Feq,
          bclose=0,
          kobe  =FALSE,
          text=F,
          rel=F,
          xmax=2.5)
```

Figure \@ref(fig:hockey) the convential hockey-stick control rule is explored with different ratios of $F_{adv}$/$F_{tgt}$ and $B_{trigger}$/$B_{tgt}$ settings, where the $B_{trigger}$ promts a linear reduction in $F_{adv}$ if $SSB$ falls below it.


```{r hockey, fig.height=3,fig.width=5,warning=FALSE,message=FALSE, fig.cap = paste0("Example Advice Rule from ICES")}
 plotGFCM(fadv = Feq,
          btrigger =Btri.eq,
          bthr = -1,
          ftgt = Feq,
          btgt=df$Btgt[2],
          blim=an(refpts["Blim"]),
          fmin=0,
          bclose=0,
          kobe  =FALSE,
          text=F,
          rel=F,
          xmax=2.5)
```
Figure \@ref(fig:alternative)  show alternative HCR formulations

```{r alternative, fig.height=8,fig.width=8,warning=FALSE,message=FALSE, fig.cap = paste0("Alternative HCR formulations, with $F_{min}=0$ (top) and $F_{min}=0.5F_{tgt}$ (bottom) under different $F_{adv}$ options set at $F_{adv}=F_{adv}$, $F_{adv}=0.8F_{adv}$ and at $F_{adv}=0.7F_{adv}$ from left to right")}

Fadv = c(df$Ftgt) 
Btgt = c(df$Btgt) 
Btri = c(df$Btrigger)

hcrs= Map(function(x,y,z){
p  = plotGFCM(fadv = x,
              btrigger =y,
              ftgt = x,
              btgt=z,
              blim=an(refpts["Blim"]),
              fmin=0,
              bclose=0,
              kobe  =FALSE,
              text=F,
              rel=F)
p = p
return(p)
},
x=Fadv,
y=Btri,
z=Btgt)
# plot ggplot list
ggarrange(plotlist=hcrs,
          nrow=4,
          ncol=4)

```

The same settings can be specified for the new `mps` function in `mse`, which allow to explore variations of the HCR parameters.

The function `combinations` enables to vary more than one parameter at the time. 

```{r eval=FALSE}
hcrs =combinations(target=Fadv,
                   trigger=0)
hcrs$trigger = Btri # Overwrite
#hcrs
save(om,
     oem,
     arule,
     hcrs,
     df,
     mseargs,
     file="rdata/inpMP.sbr.1000.rdata")
```


These changes in parameters can simply be passed on to the existing `arule` to run the variations with `mps`.  

```{r eval=FALSE,warning=FALSE, echo=TRUE}
#(dont run in krill!!!)
runs <- mps(om, 
            oem=oem,
            ctrl=arule, 
            args=mseargs,
            hcr=hcrs)
```
this a bypass to run in MAC


```{r}
# Divide en lotes de 100
ni <- length(hcrs$target)  # ← esto es clave
batch_size <- 100  # puedes ajustar este valor según tu iMac
batches <- split(seq(ni), ceiling(seq_along(seq(ni)) / batch_size))

for (b in seq_along(batches)) {
  runs_batch <- foreach(i = batches[[b]]) %dopar% {
    # mismo cuerpo del loop...
  }
  saveRDS(runs_batch, file = paste0("s1.4/runs_batch_", b, ".rds"))
}

runs <- list()
for (i in seq(ni)) {
  hcr = arule
  hcr$hcr@args$target = hcrs$target[i]
  hcr$hcr@args$trigger = hcrs$trigger[i]
  
  runi <- mp(om, oem=oem, ctrl=hcr, args=mseargs, verbose=TRUE, parallel = FALSE)
  runs[[i]] <- runi
}

```

```{r,eval=F, echo=FALSE}
#(dont run in MACs !!)
# Note the this was run on a linux cluster in parallel by HWinkler when run. 1000 iterations
library(doParallel)
load("rdata/inpMP.sbr.1000.rdata",
     verbose=T)
length(hcrs$target)
# Run in batches

ni = length(hcrs$target)
cl = ni

registerDoParallel(cl)
start = Sys.time()

runs <- foreach(i = seq(ni)) %dopar% {
  
  # set stock index
  hcr = arule
  hcr$hcr@args$target = hcrs$target[i]
  hcr$hcr@args$trigger = hcrs$trigger[i]
  
  runi <- mp(om, 
             oem=oem, 
             ctrl=hcr, 
             args=mseargs,
             verbose=T,
             parallel = FALSE)
  
  return(runi)
} # end of loop 
end = Sys.time()
time = end-start
time
```



This Figure \@ref(fig:compare) displays the results of a MSE for Antarctic krill under different fishing strategies, including the baseline scenario (`Fmsy.OM`) and a range of alternative strategies defined by different target fishing mortalities (`Feq`) and biomass triggers (`Btri.eq`). Recruitment remains relatively stable over time across scenarios, though it remains well below the initial unfished recruitment level `R0` (blue dashed line), which reflects the stock's potential in the absence of fishing. SSB shows a rapid decline from 2020 to 2025 in all scenarios, consistent with initial fishing pressure. Biomass stabilizes at lower levels afterward. Reference points are indicated:

  * `B0` (unfished biomass),
  * `Bmsy`, `Beq` (biomass at MSY and equilibrium),
  * `Blim`, `Bpa`, and `Btrigger` (limit, precautionary, and trigger reference points).
    Most scenarios lead SSB to fall below the `Bpa` and hover near or below `Blim`, indicating potential conservation concern.

Each strategy implements a different constant `Feq` ranging from 0.1 to 1.0. As expected, scenarios with higher `Feq` (e.g., `Feq1.Btri.eq`) exert stronger fishing pressure, potentially leading to less sustainable outcomes. Catch trends reflect fishing effort. Higher `Feq` scenarios yield initially higher catches, but these quickly decline due to decreasing biomass. More conservative strategies show more stable long-term catch levels.



```{r compare, warning=FALSE, fig.height=7,fig.width=9, warning=FALSE,message=FALSE, fig.cap = "Comparison of population and fishery trajectories from 2020 to 2030 under different harvest control rules. Scenarios vary by fishing mortality targets (`Feq`) and biomass trigger levels (`Btri.eq`). Panels show recruitment (top left), spawning stock biomass (top right), fishing mortality (bottom left), and catches (bottom right). Reference points (`R0`, `B0`, `Bmsy`, `Blim`, `Btrigger`, etc.) are indicated. Results illustrate the trade-offs between yield and conservation risk under different management strategies."}

nfs = length(df$Tune[-1])
tri = c(rep(".Btri.eq",
            each=nfs))
scenarios = c("Fmsy.OM",
              paste0(rep(c(df$Tune[-1]),1),tri))

names(runs) = scenarios

stks = FLStocks(lapply(runs,function(x){
  out = x@om@stock
  out = FLStockR(out)
  out@refpts = om@refpts
  out
}))

stkm = FLStocks(lapply(stks,function(x){
  stockMedians(x)
}))

plotAdvice(stkm)

save(stks,
     file=paste0("rdata/mps.ftune.sbr1000.rdata"))

```


Now combine with the Fixed $F_{MSY}$ run and see if we can do better.

```{r,eval=F}
nfs = length(df$Tune[-1])
tri = c(rep(".Btri.eq",each=nfs))
scenarios = c("Fmsy.OM",paste0(rep(c(df$Tune[-1]),1),tri))

names(runs) = scenarios

```

An easy way of basic plotting is to extract the `FLStocks` from the list of MSE runs with `lapply`

```{r,eval=F}
stks = FLStocks(lapply(runs,function(x){
  out = (x@om@stock)
  out = FLStockR(out)
  out@refpts = refpts[c(1:5)]
  out
  }))
```

This Figure \@ref(fig:compare2) presents the full historical and projected trajectories of an Antarctic krill stock under multiple harvest control rule (HCR) scenarios within a Management Strategy Evaluation (MSE) framework. The plots are divided into four panels, each depicting a key stock or fishery metric over time, from 1990 to 2030. The vertical dashed line at ~2020 marks the transition between historical data (black line) and future projections (colored ribbons).

```{r compare2, fig.height=7,fig.width=9,warning=FALSE ,message=FALSE, fig.cap = "The panels show recruitment, spawning stock biomass (SSB), fishing mortality (F), and catches from 1990 through 2030"}

ref = FLStockR(window(stock(om),end=dy))
ref@refpts = refpts
pstks = FLStocks(c(FLStocks(stock=window(ref,end=dy)),
              stks))

plotAdvice(iter(pstks,thin))+
  facet_wrap(~qname,scales="free")+
  theme_bw()+
  scale_color_manual(values=c("black",
                              ss3col(length(pstks))[-1]))+
  scale_fill_manual(values=c("darkgrey",
                             ss3col(length(pstks))[-1]))+
  geom_vline(xintercept = c(dy),
             linetype=2,col=1)+
    geom_vline(xintercept = c(fy),
               linetype=2,
               col=4)+
  scale_x_continuous(breaks=seq(1900,3000,5))+
  theme(axis.text.x = element_text(size=8, 
                                   angle=90,
                                   vjust=0.5))
```

```{r,eval=FALSE}
save(pstks,
     mseargs,
     file="rdata/shortcut_stks.sbr.rda",
     compress="xz")
```


```{r, fig.height=7,fig.width=9, warning=FALSE,message=FALSE, fig.cap = paste0("Median MSE forecast horizon under a fixed $F_{tgt}$ rule and 6 HCR scenarios")}

medstks = FLStocks(lapply(stks,function(x){
  stockMedians(x)
}))
medref = stockMedians(ref)
pmstks = FLStocks(c(FLStocks(stock=window(medref,end=dy)),
              medstks))

plotAdvice(pmstks)+
  facet_wrap(~qname,scales="free")+
  scale_color_manual(values=c("black",
                              ss3col(length(pmstks))[-1]))+
  theme_bw()+xlab("Year")+
  geom_vline(xintercept = c(dy),
             linetype=2,col=1)+
    geom_vline(xintercept = c(fy),
               linetype=2,col=4)+
  scale_x_continuous(breaks=seq(1900,3000,5))+
  theme(axis.text.x = element_text(size=8, 
                                   angle=90,vjust=0.5))

```

## Performance Evaluation with adjustment for sex-tructured stocks 

> (Review this in krill!!)
> Define Metrics for performance evaluation of sex-structured 

```{r}
metrics <- list(SB = function(x)unitSums(ssb(x)), 
                F = function(x)unitMeans(fbar(x)), 
                C = function(x)unitSums(catch(x)),
                Rec= function(x)unitSums(rec(x)))
```

Define performance statistics - ordered alphabetically

```{r}
stats <- list(
  a.medianFmsy= list(~yearMedians(F/Fmsy), name="F/Fmsy",
    desc="Median annual F/Fmsy"),
  b.medianBmsy = list(~yearMedians(SB/Bmsy), name="B/Bmsy",
    desc="Median annual B/Bmsy"),
  c.medianCmsy = list(~yearMedians(C/MSY), name="Catch/MSY",
    desc="Median Catch/MSY over years"),
  d.aavC = list(~yearMedians(iav(C)), name="AAV",
    desc="Median annual variation in catches"),
  e.riskBlim = list(~apply(iterMeans((SB/Blim) < 1),1,max), 
    name="P3(B<Blim)", desc="Probability that SSB < Blim"),
  f.P80BMSY = list(~apply(iterMeans((SB/(Bmsy * 0.8)) > 1), 1, max),
    name="B>80Bmsy", desc="Probability that SSB > 80% x Bmsy")

)
```  


## Long-term last 10 years


To improve the realism and robustness of management evaluation, we replaced the deterministic Maximum Sustainable Yield (MSY) estimate with a stochastic MSY derived from Management Strategy Evaluation (MSE). Specifically, we used the median of the total catch over the last 10 years of a simulation run where the fishing mortality was fixed at the “true” $F_{MSY}$, referred to as `Fmsy.OM`. This approach ensures that the MSY reference point reflects the outcome of the operating model under optimal fishing pressure, capturing both process and observation uncertainty from the MSE. The new MSY value is appended to the `refpts` object and used as a basis for evaluating management performance.


```{r}
refpts.perf = refpts
refpts.perf = rbind(refpts.perf,
                    FLPar(MSY= median(unitSums(catch(stks$Fmsy.OM[,ac((fy-10):fy)])))))

```

Subsequently, performance metrics were computed for each evaluated management strategy using the updated reference points. The `performance()` function was applied to the projected stock trajectories (`stks`), assessing each strategy against the MSE-derived `refpts.perf`. The evaluation includes a set of predefined metrics and summary statistics, such as probability of maintaining biomass above thresholds or average catch. The analysis focuses on the terminal 10-year period of the simulation, enabling comparisons of yield, conservation outcomes, and trade-offs across alternative harvest control rules.


```{r,warning=F,message=F}
perf <- performance(stks,
                    refpts=refpts.perf,
                    metrics=metrics, 
                    statistics=stats, 
                    years=list((fy-10):fy))

```

\pagebreak

This Figure \@ref(fig:plotlt) show the long-term performance metrics evaluation.


```{r plotlt, fig.height=6,fig.width=7,warning=FALSE,message=FALSE, fig.cap = paste0("Performance: Long-term performance evaluation")}
ncol = length(unique(perf$mp)) 
pbp = plotBPs(perf,
              statistics=c("a.medianFmsy",
                           "b.medianBmsy",
                           "c.medianCmsy",
                           "d.aavC", 
                           "e.riskBlim", 
                           "f.P80BMSY"), 
              size=3, 
              target = c(a.medianFmsy=1,
                         b.medianBmsy=1, 
                         c.medianCmsy=1,
                         g.P80BMSY=0.8),
           limit= c(e.riskBlim=0.05,
                    c.medianCmsy=0.95),
           yminmax = c(0.05, 0.95))+
  theme_bw()+
  facet_wrap(~name,scales = "free_y",ncol=2)+
  ggtitle(paste0("Performance: Reference Points"))+
  ylab("Performance statistics")+
  scale_fill_manual(values = brewer.pal(ncol, "Set3"))+
  theme(axis.text.x=element_blank())+
  xlab("Candidates")+ 
  guides(fill= guide_legend(ncol = 1))
pbp

```

The performance metrics inkrill MSE reveal several key patterns in stock status and management outcomes across different scenarios. The F/Fmsy ratios show fishing pressure levels relative to sustainable targets, with values below 1.0 indicating conservative harvest rates and values above 1.0 suggesting overexploitation risk. The B/Bmsy metrics demonstrate stock biomass relative to reference points, where values above 1.0 reflect healthy stock levels (2.5-1.5 range) and values below 1.0 (0.6-0.2 range) signal potential overfishing states. The candidate scenarios (Feq0.9.Btrl.eq to Feq0.1.Btrl.eq) systematically test reduced fishing intensities, showing progressively lower F/Fmsy ratios (from 1.050 to 0.950) paired with increasing B/Bmsy values, indicating how incremental F reductions could rebuild biomass while maintaining catches. The tight clustering of performance statistics around the 1.0 reference point for both F/Fmsy and B/Bmsy in some scenarios suggests these management procedures may effectively balance conservation and yield objectives for krill, though the wider ranges (0.2-2.5 for B/Bmsy) highlight the system's sensitivity to different harvest control rules under recruitment variability.


\pagebreak

## Performance Table



```{r,echo=F,message=F,warning=F}
dir.create("perftabs",showWarnings = F)

pf = perf[perf$statistic%in%statistic,]
df.pf = aggregate(data~mp+name,pf,mean)
sd.pf = aggregate(data~mp+name,pf,sd)
sd.pf = sd.pf[sd.pf$name=="Catch/MSY",] 
tab.pf = cbind(reshape2::dcast(df.pf,mp~name),SD.Catch=sd.pf$data)
tab.pf[,-1] = round(tab.pf[,-1],3)
# Add Fadv and Btrigger
tab.pf = data.frame(tab.pf,Fadv=df$Ftgt,Btrigger=df$Btrigger)

tab.pf = tab.pf[,c(1,9,7,5,8,2,6,3,4)]
write.csv(tab.pf,file="perftabs/ftune.tab.csv",row.names = F)

kbl(tab.pf, format = "latex", booktabs = TRUE, align = "lccccc",
    caption = "Robustness tests of $F_{adv}$ in precautionary approach under closed loop simulations with feedback control of assessment advice emulation") %>%
  kable_styling(latex_options = c("hold_position", "scale_down"))


```





```{r fig5, eval=FALSE, echo=FALSE, fig.height=8,fig.width=10, fig.cap = paste0("MSE kobe plot Advice rules"), warning=FALSE}
## MSE kobe plot
kbcex =function(){theme(plot.title = element_text(size=10),
                        legend.key.size = unit(0.3, 'cm'), #change legend key size
                        legend.key.height = unit(0.4, 'cm'), #change legend key height
                        legend.key.width = unit(0.4, 'cm'), #change legend key width
                        legend.text = element_text(size=10)) #change legend text font size
}
kobeMPs(perf,y="a.medianFmsy", x="b.medianBmsy")+
  ylab(expression(F/F[MSY]))+
  xlab(expression(B/B[MSY]))+
  ylim(0,2.5)+kbcex()+theme()+
  guides(fill= guide_legend(ncol = 1))

```

\pagebreak

# CONCLUSION


This study represents a first implementation of a Management Strategy Evaluation (MSE) for Antarctic krill based on outputs from an integrated stock assessment model. Using a deterministic operating model and closed-loop simulations, we evaluated the performance of current and alternative harvest control rules under uncertainty. The simulations reveal that FMSY-based harvest control rules can maintain the stock near target reference points (B/BMSY ~1.0), though performance is sensitive to recruitment variability and observation errors. Key limitations include: (1) simplified spatial structure, (2) unvalidated stock-recruitment relationships, and (3) preliminary treatment of implementation uncertainty. Results demonstrate the feasibility of applying MSE frameworks to krill, providing insights into trade-offs between precautionary reference points and yield. However, this preliminary exercise highlights key areas for improvement, including the incorporation of recruitment and implementation uncertainty, as well as predator–prey interactions. Future developments should also explore spatial structure and feedbacks from ecosystem indicators to enhance realism and support ecosystem-based fisheries management. This work provides a scientific basis for evaluating harvest strategies under uncertainty, offering a structured approach that can be progressively adapted to inform CCAMLR’s ecosystem-based management of the krill fishery.


\pagebreak

# CODE REPOSITORY

Krill MSE Repository Overview GitHub Link: [https://github.com/MauroMardones/Krill_MSE/tree/main](https://github.com/MauroMardones/Krill_MSE/tree/main)  

### Core Components

*Main Simulation Script*

   - `ShortCut_MSE_Krill.Rmd`:  
     - Implements the Operating Model (OM) and Management Procedures (MPs).  
     - Uses shortcut MSE methods for efficient krill population projections.  
     - Generates key outputs: F/SSB trajectories, recruitment deviations, and performance metrics.  

*Stock Assessment Data*

   - `base.model1.4.rds`:  
     - SS3 or similar assessment output used to initialize the OM (e.g., growth, mortality, recruitment parameters).
     - Provides biological reference points (*F~MSY~*, *B~trigger~*).  

*Supporting Code*

   - `MSE_Krill_FLR.Rmd`:  
     - Supplementary analyses (e.g., sensitivity tests, alternative HCRs).  
     - Visualizations (trade-off plots, Kobe matrices).  

*Project Metadata*

   - `.gitignore`, `LICENSE`, `README.md`:  
     - Standard setup for reproducibility and collaboration.  
     - `README.md` should include:  
       - Installation (e.g., `install.packages(c("FLR", "mse"))`).  
       - Workflow: How to run `ShortCut_MSE_Krill.Rmd` → validate OM → test MPs.  
       - Key Dependencies: FLR, mse, ggplot2.  


```{r}
sessionInfo()
```

\pagebreak

# REFERENCES
